"use client"

import { SharedChatLayout } from "@/components/shared-chat-layout"
import { Target, TrendingUp, DollarSign, BarChart3, Lightbulb, Users } from "lucide-react"

const suggestedTopics = [
  { icon: Lightbulb, text: "何から始めればいいかわからない" },
  { icon: TrendingUp, text: "売上が落ちてきた" },
  { icon: DollarSign, text: "ホームページを作り直したい" },
  { icon: Target, text: "SNSを始めたい" },
  { icon: Users, text: "人を雇いたい・人が辞める" },
  { icon: BarChart3, text: "広告費を増やすべき？" },
]

const STORAGE_KEY = "symphony-ceo-chat-history"

const INITIAL_MESSAGE = `こんにちは、「右腕さん」です。
中古車販売店の経営をまるごとサポートするAI参謀です。

私の中には4人の専門家がいます。
金庫番（財務）、集客参謀（マーケ）、補助金コンシェルジュ、AI CHRO（人事）——
この4人の知見を統合して「今やるべきこと」を1つの結論にまとめます。

お金、集客、補助金、人の問題——何でも相談してください。
「こうしましょう」とはっきりお答えします。

まず、お店のことを少し教えてください。

1. 在庫は今、だいたい何台ありますか？
2. 月に何台くらい売れていますか？
3. 今、一番困っていることは何ですか？`

const generateCeoResponse = (question: string, messageCount: number): string => {
  const q = question.toLowerCase()

  // 初回ヒアリング序盤
  if (messageCount <= 3) {
    if (q.match(/\d+台/) || q.includes("在庫") || q.includes("台")) {
      return `ありがとうございます。状況が見えてきました。

まず結論から言います。

お店の規模に関わらず、今すぐ確認してほしいことが2つあります。

【確認1：生存チェック】
今の通帳残高は、毎月の固定費（家賃・人件費・広告費・リース等の合計）の何ヶ月分ありますか？

- 3ヶ月以上 → 安全圏。攻めの施策を考えましょう
- 2〜3ヶ月 → 注意圏。新しい投資は慎重に
- 1〜2ヶ月 → 警戒圏。まず固定費削減と在庫圧縮が最優先
- 1ヶ月未満 → 緊急事態。すべての新規投資を止めて守りに入りましょう

【確認2：在庫の鮮度】
今の在庫のうち、仕入れから60日以上経っている車は何台ありますか？

この2つがわかれば、今やるべきことの優先順位がはっきり決まります。
ざっくりでかまいません。教えてください。`
    }

    if (q.includes("売上") || q.includes("売れない") || q.includes("落ち")) {
      return `売上が落ちている。わかりました。

まず原因の切り分けをしましょう。以下のどれに近いですか？

A) 問い合わせの数自体が減っている
B) 問い合わせはあるが、来店につながらない
C) 来店はあるが、成約しない
D) 全体的になんとなく落ちている

これによって「今週やるべきこと」がまったく変わります。

もし「A」なら、最も即効性があるのはカーセンサーの掲載写真の改善です。
0円でできて、1〜2週間で反響が変わることがあります。

まず上のA〜Dで一番近いものを教えてください。
そこから具体的なアクションプランを出します。`
    }

    if (q.includes("sns") || q.includes("インスタ") || q.includes("tiktok")) {
      return `SNSを始めたい。いい着眼点です。

ただし、順番があります。

まず確認させてください。
Googleビジネスプロフィール（Googleマップに出てくるお店の情報）は登録・整備してありますか？

もしまだなら、SNSよりMEO（Googleマップ対策）が先です。
理由は簡単で、MEOは0円で効果が大きく、「今すぐ近くで中古車を探している人」に届くからです。

SNSは効果が出るまで3ヶ月以上かかりますが、MEOは1〜3ヶ月で「地域名＋中古車」の検索に引っかかるようになります。

MEOをやっている場合は「やっています」と教えてください。
SNSの具体的な始め方を案内します。

どちらの場合も、詳しい運用のやり方は集客参謀AI（CMO）で相談できます。
まず判断を先に固めましょう。`
    }

    if (q.includes("ホームページ") || q.includes("hp") || q.includes("サイト")) {
      return `ホームページの作り直し、検討されているんですね。

まず判断の前に3つ確認させてください。

1. 今のHPは月に何件くらい問い合わせが来ていますか？
2. カーセンサー等のポータルサイトからの問い合わせは月に何件ですか？
3. HPの制作にかけられる予算のイメージはありますか？

お店の規模によって、HPの優先度は大きく変わります。

在庫30台以下の小規模店なら、HPリニューアルより先にやるべきことがあります。
MEOとカーセンサーの掲載改善で、0円〜低コストで問い合わせを増やせる可能性が高いです。

在庫30台以上で、ポータル費用が月に30万円を超えているなら、自社HPの強化は有効な投資です。
その場合、持続化補助金やIT導入補助金で自己負担を大幅に減らせる可能性もあります。

まず上の3つを教えてください。判断を出します。`
    }

    if (q.includes("人") || q.includes("雇") || q.includes("スタッフ") || q.includes("採用") || q.includes("辞め") || q.includes("離職")) {
      return `人の問題ですね。経営判断として整理します。

まず確認させてください。

1. 今の月販台数は何台ですか？
2. スタッフは何名ですか？
3. 「忙しすぎる」「人が辞める」「売上を伸ばしたい」のどれが一番近いですか？

ここで正直に言います。

月販15台未満で、忙しいから雇いたいという場合——
人を雇う前に、業務の仕組み化・効率化が先です。

理由：新人が戦力になるまで最低3〜6ヶ月。その間は人件費月20〜30万円の「持ち出し」です。
手元資金にその余裕がなければ、資金繰りを圧迫して逆効果になります。

月販15台以上かつ在庫回転が健全なら、雇う時期かもしれません。
その場合は業務改善助成金（最大600万円）が使える可能性があります。

雇うと決めたら——
具体的な採用方法・求人の書き方・受け入れ体制の整備は、
AI CHRO（人事参謀）で進めてください。
Indeedの使い方から、社員紹介の仕組みづくり、外国人採用の制度確認まで
全部サポートしてくれます。

人が辞める問題なら——
これも AI CHRO の領域です。
離職の原因分析から、受け入れ体制の改善、評価制度の作り方まで相談できます。

まず数字を教えてください。経営判断を先に出します。`
    }

    if (q.includes("広告") || q.includes("カーセンサー") || q.includes("グーネット")) {
      return `広告費の話ですね。大事な判断です。

結論を先に言います。

広告費を「増やす」前に、今の広告の中身を見直すのが先です。

確認させてください：
1. 今のカーセンサー（またはグーネット）の月額費用はいくらですか？
2. 月の問い合わせ件数は何件くらいですか？
3. 掲載車両の写真は1台あたり何枚くらいですか？

もし写真が15枚未満の車両があるなら、広告費を増やすよりも写真を20枚以上にする方が費用対効果は高いです。これは0円でできます。

また小規模店の場合、カーセンサーとグーネットの「両方掲載」はおすすめしません。
ユーザー層が大きく重複しており、費用が倍になるだけです。
どちらか1つに集中して掲載内容の質を上げる方が反響は出やすいです。

数字を教えてください。具体的なアクションを出します。`
    }

    if (q.includes("何から") || q.includes("わからない") || q.includes("始め")) {
      return `何から始めればいいかわからない。大丈夫です。一緒に整理しましょう。

まず、お店のことを3つだけ教えてください。

1. 在庫は何台くらいですか？
2. 月に何台くらい売れていますか？
3. 毎月の固定費（家賃・人件費・リース・広告費の合計）はざっくりいくらですか？

この3つがわかれば、お店の「今の健康状態」を判定して、最優先でやるべきこと1つを具体的にお伝えします。

ポイントは「1つだけ」に絞ることです。
同時に3つの施策を始めると、3つとも中途半端になります。
一番効果が高い1つに集中しましょう。

ざっくりで大丈夫です。教えてください。`
    }
  }

  // 中盤以降の応答
  if (q.includes("資金") || q.includes("お金") || q.includes("キャッシュ") || q.includes("通帳")) {
    return `お金の状況を教えてくれてありがとうございます。

ここは非常に重要なので、はっきり言います。

【判断基準】
手元資金が月の固定費の2ヶ月分を切っている場合、すべての新規投資を一旦止めてください。

今やるべきことは3つ、この順番です：

1. 90日以上の長期在庫をリストアップ → 原価割れでも現金化を優先
   在庫に寝ているお金を解放することが最優先です

2. 不要な月額サービス・サブスクをすべて洗い出して解約
   効果が出ていないポータルのプランダウンも検討してください

3. 仕入れを一時停止。「売れた分だけ次を仕入れる」ルールに切り替え

詳しい資金繰り表の作成や、銀行に持っていく資料の準備は、金庫番AI（CFO）が得意です。
具体的な数字のシミュレーションはそちらで進めてください。

まず上の1番、長期在庫は何台ありますか？`
  }

  if (q.includes("補助金") || q.includes("助成金") || q.includes("持続化")) {
    return `補助金の活用、良い視点です。

ただし1つ、大事な前提があります。

補助金は「もらえたらラッキー」で計画を立ててください。
補助金ありきで投資計画を立てると、不採択だった時に立ち行かなくなります。

まず「自己資金で回る計画」を作り、補助金が採択されたら「予定より早くできる」「追加でここまでできる」という位置づけにしましょう。

その上で、中古車販売店でよく使える補助金は：

- HPリニューアル → 小規模事業者持続化補助金（上限50〜200万円）
- 業務システム導入 → IT導入補助金（最大450万円）
- 設備投資 → ものづくり補助金
- 人件費+設備 → 業務改善助成金（最大600万円）

具体的な申請手続きや事業計画書の作成は、補助金コンシェルジュAI（補助金相談）が専門です。
投資内容と所在地を伝えれば、最適な補助金を見つけてくれます。

何に投資したいですか？ 判断を先に固めましょう。`
  }

  if (q.includes("システム") || q.includes("symphony") || q.includes("導入")) {
    return `システム導入の検討ですね。

まず確認させてください。

1. 何を解決したいですか？（在庫管理の手間／広告掲載の手間／顧客管理）
2. 初期費用＋月額費用×12ヶ月の予算を出しても、手元資金は安全圏を維持できますか？

判断のポイント：

在庫管理・一括掲載の手間を減らしたい → Symphonyのような販売管理システムは有効です。
1回の入力で10以上の広告媒体に一括掲載でき、工数が激減します。

導入のベストタイミングは閑散期（4〜5月 or 8月）です。
繁忙期（1〜3月）に導入を始めると、業務と学習が重なって混乱します。

コストを抑えるなら、IT導入補助金（補助率1/2〜3/4）が使える可能性が高いです。
自己負担を半分以下にできるかもしれません。

補助金の詳細は補助金コンシェルジュAIで、システムの具体的な選定は金庫番AI（CFO）で費用対効果を確認できます。

まず「何を解決したいか」を教えてください。`
  }

  if (q.includes("季節") || q.includes("今月") || q.includes("来月") || q.includes("繁忙") || q.includes("閑散")) {
    return `季節の話ですね。中古車は季節変動が大きいので、先手を打つことが重要です。

今の時期に合わせてお伝えします。

【今やるべきこと】
- 来月以降の仕入れ計画を今のうちに立てる
- 在庫の棚卸し。60日超えの車は値下げ or 業販で処分
- カーセンサーの掲載写真を全車確認。15枚未満は20枚以上に増やす
- Googleビジネスプロフィールの更新（最新の写真・営業時間）

【やってはいけないこと】
- 閑散期に焦って広告費を急増させること
- 繁忙期と同じペースで仕入れ続けること

年間を通した考え方として：
- 1〜3月（繁忙期）：広告費は年間最大に。在庫を最大限確保
- 4〜5月（閑散期）：改善期間。システム導入やHP制作はこの時期
- 7月（ボーナス期）：ファミリー向けの在庫を厚めに
- 11〜12月：繁忙期の準備。在庫計画と資金繰りの確認

具体的に今月どうするか、一緒に決めましょう。
今の在庫台数と月販台数を教えてください。`
  }

  // やった報告
  if (q.includes("やった") || q.includes("できた") || q.includes("やりました") || q.includes("しました") || q.includes("終わり")) {
    return `実行されたんですね。素晴らしい。

「考えた」で終わる人が大多数の中、実際に動いた。これが一番大事です。

次のステップを1つだけ出します。

今やったことを「1回きり」で終わらせないでください。
習慣に落とし込むことで、効果が何倍にもなります。

具体的には：
- やったことを「毎週○曜日にやる」とカレンダーに入れる
- 1週間後に効果を数字で確認する（問い合わせ数、来店数など）
- 数字が動かなければ、やり方を微調整する

「やる→測る→直す」のサイクルを回すだけで、小さな行動が大きな成果に変わります。

次は何に取り組みますか？ それとも、今やったことの効果測定の方法を一緒に決めましょうか？`
  }

  // デフォルト応答
  return `「${question}」について、整理してお答えします。

まず、この判断を下す前に確認させてください。

1. お店の規模はどのくらいですか？（在庫台数・月販台数）
2. 手元資金は月の固定費の何ヶ月分ありますか？

この2つがわかれば、今の状況に最適なアクションを具体的にお伝えできます。

判断の優先順位は常にこうです：
- まず「お金は足りているか？」（生存チェック）
- 次に「在庫は健全か？」（在庫の鮮度チェック）
- その上で「次に何をすべきか？」（成長施策の検討）

お金が危険なら、どんなに良い施策でも「今はやらない」が正解です。
お金が安全なら、最も効果が高い1つに絞って動きましょう。

状況を教えてください。判断を出します。`
}

export function CeoChat() {
  return (
    <SharedChatLayout
      storageKey={STORAGE_KEY}
      initialMessage={INITIAL_MESSAGE}
      historyLabel="相談履歴"
      suggestedItems={suggestedTopics}
      suggestedLabel="何でもご相談ください"
      generateResponse={(question, messageCount) => generateCeoResponse(question, messageCount ?? 0)}
      theme="ceo"
      inputPlaceholder="困っていることを話してください..."
      typingDelay={1600}
    />
  )
}
