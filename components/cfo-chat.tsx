"use client"

import { SharedChatLayout } from "@/components/shared-chat-layout"
import { Wallet, PiggyBank, Receipt, TrendingDown, Calculator, Landmark } from "lucide-react"

const suggestedTopics = [
  { icon: Wallet, text: "今月の資金繰りが不安" },
  { icon: PiggyBank, text: "手元資金を増やしたい" },
  { icon: Receipt, text: "来月の税金が払えるか心配" },
  { icon: TrendingDown, text: "在庫にお金が寝ている" },
  { icon: Calculator, text: "仕入れ予算を計算したい" },
  { icon: Landmark, text: "銀行との付き合い方を知りたい" },
]

const STORAGE_KEY = "symphony-cfo-chat-history"

const INITIAL_MESSAGE = `はじめまして、社長！「金庫番」です。
お店のお金まわりの相談相手として、何でも聞いてください。

最初に、お店のことを少しだけ教えてもらえますか？

まずこの3つだけ。

1. 今、展示場に車は何台くらいありますか？
2. 月に何台くらい売れてますか？
3. 今一番「お金のことで気になっていること」は何ですか？

これがわかれば、すぐにお店の状態が見えてきます。
難しい話はしません。商売人同士の会話で進めましょう！`

const generateCfoResponse = (question: string, messageCount: number): string => {
  const q = question.toLowerCase()

  if (messageCount <= 3) {
    if (q.includes("資金繰り") || q.includes("お金") || q.includes("不安") || q.includes("足りない")) {
      return `社長、資金繰りの不安、正直に話してくれてありがとうございます。
ここを隠すと後で大変なことになるんで、早めに相談してくれたのは正解です。

まず、お店の「体温」を測らせてください。

教えてほしいのはこの3つです：

1. 今、通帳にだいたいいくらありますか？（ざっくりでOK）
2. 毎月必ず出ていくお金はいくらですか？
   （家賃、人件費、リース料、広告費、保険料、借入返済の合計）
3. 今月、AAで仕入れに使う予定の金額はいくらですか？

これがわかれば、「あと何ヶ月やっていけるか」がすぐ計算できます。

通帳残高を毎月の固定費で割った数字が「生存月数」です。
- 3ヶ月以上あれば、ひとまず安心
- 2ヶ月を切ったら、仕入れのペースを落としましょう
- 1ヶ月を切ったら、緊急モードです。すぐ対策を打ちます

数字を教えてください。一緒にお金の見通しを作りましょう。`
    }

    if (q.match(/\d+台/) || q.includes("在庫") || q.includes("台")) {
      return `ありがとうございます、社長。お店の規模が見えてきました。

じゃあ次に、お金まわりのことを少し教えてください。

1. 毎月必ず出ていくお金（家賃、人件費、広告費、リース等の合計）はだいたいいくらですか？
2. 1台あたりの儲け（粗利）はだいたいいくらですか？
3. 今、通帳にざっくりいくら残ってますか？

これで「お店のお金の健康診断」ができます。

ちなみに、在庫台数と月の販売台数から計算すると、
在庫が売れるまでの平均日数がだいたい出ます。

目安として：
- 60日以内なら、よく回ってます
- 60〜90日なら、ちょっと重いですね
- 90日超えてたら、お金が寝ちゃってる状態です

在庫にかけてるお金の総額もざっくり教えてもらえると、
もっと具体的なアドバイスができますよ。`
    }

    if (q.includes("税金") || q.includes("消費税") || q.includes("払え")) {
      return `社長、税金の心配ですね。
中古車屋さんで一番怖いのは、実は消費税なんです。

1台100万円の車を年間120台売ったら、消費税だけで年間数百万円が動きます。
売上が伸びた翌年に「消費税ドカン」は、この業界のあるあるです。

まず確認させてください：

1. 法人ですか？ 個人事業主ですか？
2. 決算月は何月ですか？
3. 消費税用の「貯金」は別口座で管理してますか？

もし消費税の貯金をしてないなら、今日からやりましょう。
やり方はシンプルです。
毎月の売上の2〜3%を別の口座に移すだけ。

仕入れに使いたくなる気持ちはわかりますが、
税金を払えなくなったら、銀行の信用もガタ落ちです。

まず上の3つを教えてください。
今後12ヶ月の「税金カレンダー」を一緒に作りましょう。`
    }
  }

  if (q.includes("在庫") || q.includes("回転") || q.includes("寝て")) {
    return `社長、在庫にお金が寝てる感じですね。
在庫は冷蔵庫の中の食材と一緒です。古くなったら価値ゼロです。

在庫の「健康診断」をしましょう。教えてください：

1. 今の在庫台数と、仕入れにかけてる合計金額
2. 一番古い在庫は、何日前に仕入れたものですか？
3. 3ヶ月以上動いてない車は何台ありますか？

在庫の鮮度チェックの基準はこうです：

- 30日以内 → 新鮮。しっかり利益を取って売りましょう
- 31〜60日 → そろそろ値段を見直す時期です
- 61〜90日 → 思い切って値下げするか、業販に出しましょう
- 91日以上 → 今すぐAAに出すか、大幅値引きで処分です

「もったいない」と思う気持ちはわかります。
でもね、社長、損切りしても、そのお金で新しい車を仕入れれば、
次の粗利で十分取り返せるんです。

「高く売る」より「早く売る」が中古車の鉄則です。

在庫リスト、一緒に見ていきましょう。数字を教えてください。`
  }

  if (q.includes("仕入れ") || q.includes("予算") || q.includes("aa") || q.includes("オークション")) {
    return `社長、仕入れ予算の話ですね。ここが商売の肝です。

「いくらまで仕入れていいか」の計算式を教えます。

仕入れに使えるお金 ＝
  今の通帳残高
  ＋ 今月入ってくる確実なお金（納車済みで未入金分）
  − 今月必ず出ていくお金（固定費＋借入返済＋税金）
  − とっておき（固定費1ヶ月分は絶対に触らない）

残った分だけが「仕入れに回していいお金」です。

AA前日には、この5つを確認してください：

1. 通帳に今いくらある？
2. 今週入金予定のお金はある？
3. 今週出ていく支払いはある？
4. 在庫の中で今月売れそうな車は何台？
5. 今の在庫台数は適正か？（月販台数の2〜3倍が目安）

全部OKなら仕入れGO。1つでも不安なら今週は見送りです。

社長の数字を教えてもらえれば、今月の仕入れ予算を一緒に計算しますよ。`
  }

  if (q.includes("銀行") || q.includes("借入") || q.includes("融資") || q.includes("公庫")) {
    return `社長、銀行との付き合い方ですね。
「お金を借りる」は悪いことじゃないですよ。
仕入れた車がちゃんと売れるなら、借りて回した方が商売は伸びます。

銀行に好かれるお店の条件はシンプルです：

- 毎月のお金の出入り予定表を作ってる
- 売上・仕入れ・利益の数字を説明できる
- 借りたお金を約束通り返し続けてる
- 「何のために借りたいか」を具体的に言える

一番大事なのはタイミングです。
お金に余裕がある時に相談するのがベスト。
困ってから駆け込むと、銀行の対応が100倍違います。

融資の種類も簡単に説明しますね：

- 短期の融資 → AA仕入れの立て替え用。売れたら返す
- 長期の融資 → 設備投資（リフト、PC、店舗改装等）用
- 日本政策金融公庫 → 民間より借りやすい。金利も低め
- 信用保証協会付き → 小さいお店でも借りやすくなる

銀行に持っていく資料（経営計画書、資金繰り表）の作り方も
一緒にやれますよ。何を相談したいですか？`
  }

  if (q.includes("増やす") || q.includes("改善") || q.includes("手元")) {
    return `社長、お金を増やしたい。いい質問です。
守りだけじゃなく攻めも大事ですからね。

すぐできること（0円でできる）から順番に行きましょう：

【すぐやれること】

1. 入金を早める
   - ローン会社の入金サイクルを確認。より早い会社はないか？
   - 頭金はその場で現金でいただく運用に
   - 納車前入金を徹底する

2. 支払いを遅らせる（信用を落とさない範囲で）
   - 広告費・整備部品代の支払い条件を交渉
   - ※銀行返済と税金だけは絶対に遅らせないでください

3. 在庫を絞る
   - 「なんとなく仕入れ」をやめる
   - 長期在庫は勇気の損切り。お金を解放しましょう

4. 付帯収入を増やす
   - 任意保険の提案（毎年手数料が入ります）
   - コーティング、ドラレコ取付
   - 車検入庫の促進

この中で、社長のお店で一番やりやすそうなのはどれですか？
1つに絞って、今週から始めましょう。`
  }

  // デフォルト応答
  return `社長、「${question}」ですね。

お金まわりのことなら何でも相談に乗りますよ。

ちょっと確認させてください。
今一番気になっているのは、次のどれに近いですか？

- 今月・来月の支払いが回るか不安
- 在庫にかけてるお金が多すぎる気がする
- 仕入れにどれくらい使っていいかわからない
- 税金の準備ができてるか心配
- 銀行から借りた方がいいか迷っている
- 毎月の数字の見方がわからない

1つ教えてもらえれば、そこからお話ししますよ。
社長のペースで大丈夫です。`
}

export function CfoChat() {
  return (
    <SharedChatLayout
      storageKey={STORAGE_KEY}
      initialMessage={INITIAL_MESSAGE}
      historyLabel="相談履歴"
      suggestedItems={suggestedTopics}
      suggestedLabel="お金のお悩みは？"
      generateResponse={(question, messageCount) => generateCfoResponse(question, messageCount ?? 0)}
      theme="cfo"
      inputPlaceholder="お金の悩みを相談..."
      typingDelay={1600}
    />
  )
}
