"use client"

import { SharedChatLayout } from "@/components/shared-chat-layout"
import { Award, FileCheck, Globe, Laptop, Wrench, Building2 } from "lucide-react"

const suggestedTopics = [
  { icon: Globe, text: "HPリニューアルに使える補助金は？" },
  { icon: Laptop, text: "業務システム導入の補助金を知りたい" },
  { icon: Wrench, text: "設備投資に使える助成金は？" },
  { icon: FileCheck, text: "持続化補助金について教えて" },
  { icon: Award, text: "IT導入補助金の対象になる？" },
  { icon: Building2, text: "うちの地域の独自補助金は？" },
]

const STORAGE_KEY = "symphony-grant-chat-history"

const INITIAL_MESSAGE = `こんにちは！中古車販売店専門の助成金・補助金コンシェルジュAIです。

お店の状況に合った補助金を最速でお探しします。
まずは3つだけ教えてください。

1. お店の場所はどちらですか？（都道府県・市区町村）
2. 従業員数は何名ですか？（パート含む常勤換算）
3. 何に投資したいですか？
   例：HPリニューアル、業務システム導入、店舗改装、整備設備、AI活用...

この3つがわかれば、すぐに候補をご提案できます！`

const generateGrantResponse = (question: string, messageCount: number): string => {
  const q = question.toLowerCase()

  if (messageCount <= 3) {
    if (q.includes("hp") || q.includes("ホームページ") || q.includes("サイト") || q.includes("web")) {
      return `HPリニューアルに使える補助金、いくつかあります！

【最も推奨】小規模事業者持続化補助金
- 補助額：上限50万円（特例活用時は最大250万円）
- 補助率：2/3（赤字事業者は3/4）
- 対象経費：HP制作費＋チラシ・広告費＋展示場改装等
- 重要な制約：
  HP費用「のみ」では申請不可です。他の経費と組み合わせが必須。
  HP費用は補助金総額の1/4が上限。
  例：HP制作50万＋チラシ20万＋看板30万＝合計100万→補助66万
- 難易度：低〜中

【併用候補】デジタル化・AI導入補助金（旧IT導入補助金）
- 補助額：5万〜450万円
- 補助率：1/2〜4/5
- 対象：登録されたITツール・HP制作ツールに限定
- 注意：自由にHP制作会社を選べるわけではありません
- 難易度：中

より具体的な提案をするために教えてください：

1. お店の所在地はどちらですか？（自治体独自の補助金も探せます）
2. 従業員は何名ですか？（小規模事業者かどうかの判定に必要です）
3. HPの制作予算のイメージはありますか？
4. HPリニューアル以外にも投資したいものはありますか？

※補助金情報は制度変更が頻繁にあります。必ず公式サイトで最新情報をご確認ください。`
    }

    if (q.includes("システム") || q.includes("it") || q.includes("ソフト") || q.includes("crm") || q.includes("在庫管理")) {
      return `業務システム導入の補助金ですね。中古車販売店にぴったりのものがあります。

【最も推奨】デジタル化・AI導入補助金（旧IT導入補助金）
- 補助額：5万〜450万円
- 補助率：1/2〜4/5
- 中古車販売店での活用例：
  - 在庫管理システム（Symphony等）
  - CRM（顧客管理）ソフト
  - 会計ソフト
  - AI査定ツール
  - 電子契約システム
- 注意点：
  - 登録されたIT導入支援事業者・ITツールから選ぶ必要あり
  - GビズIDプライムが必須（取得に2〜3週間かかる場合あり）
- 難易度：中

【併用候補】業務改善助成金
- 補助額：最大600万円
- 助成率：3/4〜9/10
- 条件：事業場内最低賃金の引上げが必須
- PC・タブレット・決済端末なども対象
- 難易度：低

【金額シミュレーション例】
システム導入費用200万円の場合：
- IT導入補助金（補助率1/2）→ 自己負担100万円
- IT導入補助金（補助率4/5）→ 自己負担40万円

詳しく提案するために教えてください：
1. お店の所在地
2. 従業員数
3. 具体的に導入したいシステムは決まっていますか？
4. 投資予定金額のイメージ

※補助金は後払いです。先に自己資金で支払い、事業完了後に精算される点にご注意ください。`
    }

    if (q.includes("設備") || q.includes("リフト") || q.includes("整備") || q.includes("改装") || q.includes("店舗")) {
      return `設備投資の補助金ですね。投資の内容によって最適な補助金が変わります。

【店舗改装・看板等の場合】
小規模事業者持続化補助金
- 補助額：上限50万円（特例活用時は最大250万円）
- 補助率：2/3
- 対象：展示場改装、看板設置、チラシ作成等
- 難易度：低〜中

【整備設備（リフト・塗装ブース等）の場合】
ものづくり補助金
- 補助額：750万〜1,250万円
- 補助率：1/2〜2/3（小規模事業者は2/3）
- 注意：「革新性」が求められます（単なる更新は不可）
- 難易度：高

中小企業省力化投資補助金
- 補助額：最大1億円
- 補助率：1/2〜2/3
- 対象：人手不足解消のための設備
- 条件：賃上げ要件（最低2%の賃上げ）
- 難易度：中〜高

【PC・タブレット等の小型設備の場合】
業務改善助成金
- 補助額：最大600万円
- 助成率：3/4〜9/10
- 条件：最低賃金引上げが必須
- PC、タブレット、POS等が対象
- 難易度：低

お店の所在地と投資内容の詳細を教えてください。
自治体独自の補助金も含めて、最適な組み合わせを提案します。`
    }

    if (q.match(/[都道府県市区町村]/) || q.includes("東京") || q.includes("大阪") || q.includes("名古屋") || q.includes("福岡") || q.includes("北海道") || q.includes("愛知") || q.includes("神奈川") || q.includes("千葉") || q.includes("埼玉")) {
      return `所在地の情報ありがとうございます！

国の補助金に加えて、お住まいの地域の自治体独自の補助金も活用できる可能性があります。

【国の主要補助金（中古車販売店に特に有効）】

1. 小規模事業者持続化補助金
   → HP+チラシ+店舗改装のセット申請に最適
   
2. デジタル化・AI導入補助金（旧IT導入補助金）
   → システム導入・AI活用に最適

3. ものづくり補助金
   → 革新的な設備投資に

4. 業務改善助成金
   → PC購入+賃上げのセットに

5. 中小企業省力化投資補助金
   → 自動化・省力化設備に

【確認したいこと】
自治体の独自補助金は公募時期が限られるため、以下を教えてください：

1. 従業員数は何名ですか？
2. 法人ですか？個人事業主ですか？
3. 何に投資したいですか？（複数OK）
4. 投資予定金額のイメージは？
5. いつ頃実施予定ですか？
6. 過去に補助金を使ったことはありますか？

これで最適な補助金を絞り込んで、申請スケジュールも合わせて提案できます！

※自治体の補助金は年度によって内容が変わります。
  最新情報は都道府県の産業振興公社HPで確認することをおすすめします。`
    }
  }

  if (q.includes("持続化") || q.includes("jizokuka")) {
    return `小規模事業者持続化補助金について詳しくご説明します。

【概要】
- 管轄：中小企業庁
- 補助額：通常枠で上限50万円、特例活用時は最大250万円
- 補助率：2/3（赤字事業者は3/4）

【中古車販売店での活用例】
- HP制作＋チラシ・広告（ウェブサイト関連費＋広報費）
- 展示場の改装・看板設置（機械装置等費）
- 顧客管理・予約システム導入

【重要な制約】
- ウェブサイト関連費「のみ」では申請不可。他の経費と併用が必須
- ウェブサイト関連費は補助金総額の1/4が上限
- 商工会/商工会議所で「事業支援計画書（様式4）」の発行が必要
- 従業員数：商業・サービス業5人以下が「小規模事業者」の条件

【申請の流れ】
1. GビズIDプライムを取得（2〜3週間かかる場合あり）
2. 商工会/商工会議所に相談予約
3. 経営計画書・補助事業計画書を作成
4. 様式4の発行を受ける
5. 電子申請で提出

【採択率を上げるポイント】
- 数値目標を具体的に書く（「問い合わせ月20件→50件」等）
- 自社の強みと市場の課題を結びつける
- 補助事業の「新規性」を明確にする
- 加点項目を可能な限り取得する（賃上げ加点、経営力向上計画等）

事業計画書の作成もサポートできます。
申請を進める場合、まずGビズIDの取得状況を確認しましょう。お持ちですか？`
  }

  if (q.includes("申請") || q.includes("準備") || q.includes("始める") || q.includes("書類")) {
    return `申請準備を始めましょう！

まず確認させてください。どの補助金に申請しますか？
決まっていなければ、投資内容と予算から最適なものを提案します。

【どの補助金でも共通で必要な準備】

□ GビズIDプライムの取得
  - まだの場合、今すぐ申請してください
  - 取得に2〜3週間かかる場合があります
  - gbiz-id.go.jp で申請可能

□ 決算書・確定申告書（直近1〜2期分）
  - 法人→決算書
  - 個人→確定申告書の控え

□ 見積書（投資対象の具体的な見積り）
  - HP制作会社、システム会社等から取得
  - 金額の内訳が明確になっているもの

□ 事業計画書の素案
  - 「何のために」「いくら使って」「どんな効果を見込むか」
  - 数値目標は具体的であるほど採択率UP

【持続化補助金の場合、追加で必要】
□ 商工会/商工会議所への相談予約
  - 様式4（事業支援計画書）の発行が必須
  - 締切の2週間前までに相談することを推奨

投資内容が決まっていれば、事業計画書のドラフト作成もお手伝いします。
何に投資する予定ですか？`
  }

  // デフォルト応答
  return `「${question}」についてお答えします。

最適な補助金を特定するために、以下の情報を教えてください：

1. お店の所在地（都道府県・市区町村）
   → 自治体独自の補助金を探すために必要です

2. 従業員数（パート含む常勤換算）
   → 小規模事業者かどうかの判定に必要です

3. 投資したい内容
   - HPリニューアル
   - 業務管理システム
   - AI・DXツール
   - 店舗設備・改装
   - 整備設備
   - その他

4. 投資予定金額（ざっくりでOK）

5. 実施時期（いつ頃？）

これがわかれば、国の補助金＋自治体の補助金の中から最適なものを即座にご提案できます。

なお、補助金は「交付決定前の発注・契約は補助対象外」となります。
先に業者と契約してしまうと使えなくなるので、この点は特にご注意ください。`
}

export function GrantChat() {
  return (
    <SharedChatLayout
      storageKey={STORAGE_KEY}
      initialMessage={INITIAL_MESSAGE}
      historyLabel="相談履歴"
      suggestedItems={suggestedTopics}
      suggestedLabel="補助金のご相談は？"
      generateResponse={(question, messageCount) => generateGrantResponse(question, messageCount ?? 0)}
      theme="grant"
      inputPlaceholder="補助金・助成金について相談..."
      typingDelay={1500}
    />
  )
}
