"use client"

import { SharedChatLayout } from "@/components/shared-chat-layout"
import { Megaphone, Camera, MapPin, Smartphone, Globe, Star } from "lucide-react"

const suggestedTopics = [
  { icon: MapPin, text: "MEO対策って何から始める？" },
  { icon: Camera, text: "車選びドットコムの写真を改善したい" },
  { icon: Smartphone, text: "Instagram運用のコツを知りたい" },
  { icon: Star, text: "口コミを増やしたい" },
  { icon: Globe, text: "自社サイトに集客したい" },
  { icon: Megaphone, text: "広告費を最適化したい" },
]

const STORAGE_KEY = "symphony-cmo-chat-history"

const INITIAL_MESSAGE = `こんにちは！WEBマーケティング参謀AIです。
お店のWEB集客について、何でもご相談ください。

最初に3つだけ教えてください。

1. 在庫は何台くらいで、月に何台くらい売れていますか？
2. 車選びドットコム等のポータルサイトは使っていますか？
3. WEB集客で今一番「もったいないな」と感じていることは？

お店の規模に合った、無理のない集客プランを一緒に考えましょう。`

const generateCmoResponse = (question: string, messageCount: number): string => {
  const q = question.toLowerCase()

  if (messageCount <= 3) {
    if (q.includes("meo") || q.includes("googleマップ") || q.includes("グーグル") || q.includes("マップ") || q.includes("ビジネスプロフィール")) {
      return `MEO対策、素晴らしい着眼点です！
中古車販売店にとって、0円で始められる最強の集客施策の一つです。

MEOとは、Googleマップで「地域名＋中古車」と検索した時にお店が上位に表示されるようにする対策です。

【今週やること（全部無料）】

1. Googleビジネスプロフィールに登録（まだなら）
   - google.com/business で検索して登録
   - 正確な営業時間・住所・電話番号を入れる

2. 写真を10枚以上登録する
   - 展示場の外観（わかりやすい角度で）
   - 店内の様子
   - スタッフの写真（親しみやすさ）
   - 在庫車の写真（3〜5台分）

3. 口コミへの返信を全部する
   - 良い口コミにも悪い口コミにも、丁寧に返信
   - 返信している店は「ちゃんとしてる」と見られます

4. 週1回「投稿」機能で情報発信
   - 「入荷しました！」「納車おめでとうございます！」
   - 短文＋写真1枚でOK。5分で終わります

効果が見えるまで：1〜3ヶ月が目安です。

まずGoogleビジネスプロフィールの登録状況を教えてください。
すでに登録済みなら、次のステップをお伝えします。`
    }

    if (q.includes("写真") || q.includes("車選び") || q.includes("掲載")) {
      return `掲載写真の改善、これは0円でできて最も効果が高い施策です。

写真のクオリティだけで問い合わせが2〜3倍変わることがあります。

【写真の鉄則ルール】

■ 枚数：最低20枚。30枚以上が理想
掲載枚数は検索順位にも影響する傾向があります。

■ 必須カット（これは全車共通で撮る）：
- 外観4方向（フロント、リア、左、右）
- 室内（運転席、助手席、後席）
- メーター周り
- エンジンルーム
- タイヤ（溝の状態がわかるように）
- ナビ・オーディオ
- 装備のアピールポイント

■ 撮り方のコツ：
- 明るい場所で撮る（曇天の屋外がベスト。影が均一になります）
- スマホは横向きで撮る（ポータルの表示に最適）
- 背景を整理する（他の車やゴミが映り込まない）
- 車は必ず洗車してから撮る

■ コメント（PR文）のルール：
- スペック羅列だけはNG
- 「この車の良いところ」を1つ具体的に書く
  例：「後席が広いのでチャイルドシート2台でも余裕があります」
- お店の特徴を1行入れる
  例：「納車前に○項目の点検を実施します」
- 文字数は200〜400文字が読まれやすいです

まず在庫車の中で、写真が15枚未満の車両をリストアップしてみてください。
そこから優先的に撮り直していきましょう。何台くらいありそうですか？`
    }

    if (q.includes("instagram") || q.includes("インスタ") || q.includes("sns") || q.includes("tiktok")) {
      return `SNS運用のご相談ですね。お店の規模と状況に合わせてお答えします。

まず大前提をお伝えします。

小規模店のSNSは「バズらせる」ものではありません。
「お店の日常を見せる窓」として、来店前の不安を消すのが目的です。
フォロワー数は追わなくてOKです。

【Instagramから始めるのがおすすめ】

理由：
- 写真1枚＋一言で投稿できる（文章力不要）
- 車の写真はそもそも映える素材
- 地域のハッシュタグで近隣住民に届きやすい

投稿ネタ5パターン（これを回すだけ）：
1. 入荷した車の紹介（1枚＋「○○が入荷しました！」）
2. 納車のお客様写真（「おめでとうございます！」許可必須）
3. 整備・洗車の様子（「丁寧にやってます」が伝わればOK）
4. お店の日常（天気、季節感、スタッフの一言）
5. 車のプチ知識（「タイヤの溝はここを見てください」等）

ハッシュタグの付け方：
- 地名系：#○○市 #○○区 #○○市中古車
- 車種系：#タント #アルファード #軽自動車
- 業種系：#中古車販売 #中古車 #車好きと繋がりたい
- 5〜10個でOK

【1日10分SNSルーティン】
月・水・金：写真1枚撮って投稿（5分）
火・木：DMやコメントの確認・返信（3分）
土・日：納車があれば写真を撮って投稿

これで週2〜3投稿が自然に回ります。
まず今日、Instagramアカウントの状況を教えてください。
既にあるなら、フォロワー数と最後の投稿日を教えてもらえれば改善点をお伝えします。`
    }

    if (q.includes("口コミ") || q.includes("クチコミ") || q.includes("レビュー")) {
      return `口コミ集め、大事ですね！
Googleの口コミは、無料で最も信頼される広告です。

【口コミを増やす方法】

1. 納車時にお願いする（最も効果的）
   「お手数ですが、Googleで口コミを書いていただけると嬉しいです」
   QRコードを印刷したカードを渡すと書いてもらいやすくなります。

2. 過去のお客様にLINEで依頼する
   「○○さん、お車の調子いかがですか？
    もしよろしければ、Googleで口コミを書いていただけると
    大変ありがたいです」
   こんな感じで、アフターフォローとセットで送ると自然です。

3. 口コミには必ず返信する
   良い口コミ → 感謝の言葉を具体的に
   悪い口コミ → 謝罪＋改善の姿勢を見せる
   返信がある店は「ちゃんとしてる」と思われます。

【目標】まず10件、星4.5以上を目指しましょう。

【絶対やってはいけないこと】
- 口コミの自作自演（規約違反、発覚するとペナルティ）
- 割引と引き換えの口コミ依頼（Googleの規約に抵触する場合あり）
- ネガティブな口コミの削除依頼（事実なら真摯に対応する方が信頼UP）

QRコード付きの口コミ依頼カードは、QRコード生成ツールで簡単に作れますよ。
まず今の口コミ件数と評価を教えてください。`
    }
  }

  if (q.includes("広告費") || q.includes("予算") || q.includes("コスト") || q.includes("費用対効果")) {
    return `広告費の最適化ですね。規模別の目安をお伝えします。

【小規模店（在庫〜30台・月販〜10台）の場合】
月のWEB予算：10〜30万円

配分の考え方：
- ポータル掲載料（車選びドットコム等）：60〜80%
- MEO・LINE・SNS：0円（自分の時間だけ）
- 予備：20〜40%

今の段階では「費用の中でできること」を最大化するのが先です。

【重要なポイント】
小規模店が複数ポータルに出すのはおすすめしません。
ユーザー層が大きく重複しており、費用が倍になるだけです。
「複数に2万円ずつ」より「車選びドットコムに4万円で質を上げる」方が反響が出やすいです。

【効果測定の基本】
毎月この5つだけ記録してください：
1. WEB問い合わせ件数（全チャネル合計）
2. 来店数（WEB経由）
3. 成約数（WEB経由）
4. WEB費用の合計
5. 1成約あたりのWEB費用（4÷3）

5番が1台の粗利を超えていたら、広告のやり方に問題があります。

お店の規模と今の広告費を教えてください。
具体的な最適化プランを出しますよ。`
  }

  if (q.includes("自社サイト") || q.includes("ホームページ") || q.includes("seo")) {
    return `自社サイトの集客ですね。お店の規模によって優先度が変わります。

【在庫30台以下の小規模店の場合】
正直に言うと、自社サイトの優先度はまだ高くありません。

先にやるべきこと：
1. MEO（Googleマップ対策）→ 0円、1〜3ヶ月で効果
2. 車選びドットコムの掲載改善 → 0円、1〜2週間で効果
3. LINE公式アカウント → 無料プラン

この3つをやってから、自社サイトを検討しても遅くないです。

【在庫30台以上の中規模店の場合】
自社サイト強化は有効な投資です。

やること：
- 在庫検索機能つきサイトへリニューアル
- Symphonyとの連携で在庫情報を自動掲載
- お客様の声ページ（具体的なエピソード）
- 「○○市で中古車を買うなら」等のローカルSEOページ
- ブログ：「中古車選びのコツ」等のお役立ちコンテンツ

コスト：リニューアル50〜150万円 / 運用月3〜10万円
効果が見えるまで：6〜12ヶ月（SEOは時間がかかります）

持続化補助金やIT導入補助金で自己負担を減らせる可能性もあります。

お店の規模と現状を教えてください。
今やるべきか、後でいいか、判断を出しますよ。`
  }

  // デフォルト応答
  return `「${question}」について、お店の状況に合わせてお答えします。

まず確認させてください：

1. 在庫台数と月販台数はどれくらいですか？
2. 今使っている広告媒体は何ですか？（車選びドットコム等）
3. WEBにかけている月の合計費用はいくらですか？

この3つがわかれば、お店の規模（S/M/L）に合った具体的な集客プランを出せます。

お店の規模によって「今やるべきこと」と「今はやらなくていいこと」がはっきり分かれます。
無理のない範囲で、一番効果が高いことから順番にやっていきましょう。

教えてください！`
}

export function CmoChat() {
  return (
    <SharedChatLayout
      storageKey={STORAGE_KEY}
      initialMessage={INITIAL_MESSAGE}
      historyLabel="相談履歴"
      suggestedItems={suggestedTopics}
      suggestedLabel="集客のお悩みは？"
      generateResponse={(question, messageCount) => generateCmoResponse(question, messageCount ?? 0)}
      theme="cmo"
      inputPlaceholder="集客の悩みを相談..."
      typingDelay={1500}
    />
  )
}
