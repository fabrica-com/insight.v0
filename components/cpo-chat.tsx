"use client"

import { SharedChatLayout } from "@/components/shared-chat-layout"
import { BarChart3, Calculator, TrendingUp, FileSpreadsheet, PieChart, CalendarRange } from "lucide-react"

const suggestedTopics = [
  { icon: Calculator, text: "うちは月何台売れば赤字にならない？" },
  { icon: FileSpreadsheet, text: "年間の予算を作りたい" },
  { icon: TrendingUp, text: "先月の実績を振り返りたい" },
  { icon: PieChart, text: "車種別にどれが儲かっているか知りたい" },
  { icon: BarChart3, text: "決算書の読み方を教えて" },
  { icon: CalendarRange, text: "3年計画を作りたい" },
]

const STORAGE_KEY = "symphony-cpo-chat-history"

const INITIAL_MESSAGE = `こんにちは、「AI経営企画室」です。
予算づくり、数字の振り返り、データ分析——
「数字で考える経営」をお手伝いします。

難しい表やグラフは使いません。
「今月は予算に対してどうだったか」「来月どうすべきか」
を一緒に見ていきましょう。

まず、お店のことを少し教えてください。

1. 月に平均何台くらい売れていますか？
2. 1台あたりの儲け（粗利）はだいたいいくらですか？
3. 毎月の固定費（家賃・人件費・広告費等）の合計はだいたいいくらですか？

この3つがわかれば、まず「トントンのライン」を出せます。`

const generateCpoResponse = (question: string, messageCount: number): string => {
  const q = question.toLowerCase()

  // 損益分岐点・トントンのライン
  if (q.includes("赤字") || q.includes("トントン") || q.includes("損益分岐") || q.includes("何台売れば")) {
    return `損益分岐点（トントンのライン）を出しましょう。

計算はシンプルです。

毎月の固定費（家賃・人件費・広告費・リース等の合計）
÷ 1台あたりの総合粗利（車両粗利＋諸費用＋保険＋ローン手数料）
＝ 最低必要販売台数

例えば：
- 月の固定費が200万円
- 1台の総合粗利が30万円
→ 200 ÷ 30 ＝ 6.7台 → 月7台売ればトントン

ポイントは「総合粗利」で計算することです。
車両本体の粗利だけだと8〜15%ですが、
諸費用・保険・ローン手数料を含めると25%前後まで上がるのが一般的です。

教えてください：
1. 毎月の固定費の合計はだいたいいくらですか？
2. 1台売った時のトータルの儲けはいくらくらいですか？

ざっくりで大丈夫です。そこから計算します。`
  }

  // 予算策定
  if (q.includes("予算") || q.includes("計画") || q.includes("目標")) {
    return `予算を作りましょう。難しいExcelは要りません。

やることは3ステップです。

【STEP 1：トントンのラインを出す】
月の固定費 ÷ 1台あたり総合粗利 ＝ 最低必要販売台数
→ これが「最低ライン」。ここを下回ったら赤字

【STEP 2：目標利益を決める】
社長の生活費＋税金＋借入返済を賄える額を月の目標利益に。
（月固定費 ＋ 目標利益）÷ 1台あたり総合粗利 ＝ 目標販売台数

【STEP 3：季節配分する】
中古車は季節変動が大きいです。毎月同じ台数の予算は現実離れしています。

ざっくりの目安：
- 1〜3月：年間のピーク（120〜160%）
- 4〜6月・8月：閑散期（70〜90%）
- 7月・9〜12月：通常〜やや高め（90〜120%）

まず教えてください：
1. 今の月の固定費合計はいくらですか？
2. 1台あたりの粗利はどのくらいですか？
3. 月にいくらくらい利益が欲しいですか？

この3つで年間予算の骨組みを作ります。`
  }

  // 月次振り返り・予実管理
  if (q.includes("振り返") || q.includes("先月") || q.includes("実績") || q.includes("予実") || q.includes("レビュー")) {
    return `先月の振り返りをしましょう。15分で終わります。

確認するのは5つの数字だけです。

1. 販売台数 → 予算（目標）に対して何台でしたか？
2. 粗利合計 → 予算に対していくらでしたか？
3. 1台あたりの粗利 → いつもと比べてどうでしたか？
4. 広告費 → 予算通りでしたか？
5. 営業利益（粗利 - 固定費） → プラスでしたか？マイナスでしたか？

もしわかれば教えてください。差異の原因を一緒に分析します。

全部わからなくても大丈夫です。
「先月は○台売れた」「粗利はだいたい○万円だった」
だけでも、かなりのことがわかります。

数字がズレていた場合のパターンは大きく4つ：
A) 台数が足りない → 集客の問題 → AI集客参謀（CMO）と改善
B) 粗利が低い → 仕入れ or 値引きの問題
C) 両方足りない → 集客＋値付け両方に課題
D) 台数・粗利は予算通りだが利益が少ない → 固定費オーバー

わかる範囲で教えてください。`
  }

  // 車種別分析
  if (q.includes("車種") || q.includes("儲か") || q.includes("利益率") || q.includes("何が売れ")) {
    return `車種別の収益分析をしましょう。

確認したいのは「どの車種が本当に儲かっているか」です。

よくある誤解：「台数が多い車種＝儲かっている車種」
実際は：「台数 × 1台あたり粗利」で見ないとわからない

例えば：
- 軽自動車：月8台売れるが1台の粗利15万円 → 月間粗利120万円
- ミニバン：月3台だが1台の粗利40万円 → 月間粗利120万円

台数ではミニバンの半分以下でも、稼ぎは同じ。
さらにミニバンの方が在庫回転が遅いなら、軽の方が効率的。

分析するために教えてください：
1. 主にどんな車種を扱っていますか？（軽・コンパクト・ミニバン・SUV等）
2. 車種ごとの月の販売台数はざっくりわかりますか？
3. 車種ごとの平均的な粗利は違いますか？

Symphonyなどの販売管理データがあれば、さらに詳しく分析できます。`
  }

  // 決算書の読み方
  if (q.includes("決算") || q.includes("試算表") || q.includes("損益計算") || q.includes("読み方")) {
    return `決算書を「社長語」に翻訳しましょう。

難しい会計用語は忘れてください。
見るべき数字は3つだけです。

【1. 儲かっているか？】
売上 - 仕入れ代 - 経費 ＝ 営業利益
→ プラスなら本業で儲かっている。マイナスなら本業が赤字

【2. 効率はどうか？】
粗利率 ＝ 粗利 ÷ 売上 × 100
→ 中古車販売なら15〜25%が一般的
→ これより低ければ「安く売りすぎ」か「高く仕入れすぎ」

1人あたり粗利 ＝ 年間粗利 ÷ スタッフ数
→ 1人500万円以上が健全な目安

【3. 安全か？】
手元資金 ÷ 月の固定費 ＝ 生存月数
→ 3ヶ月以上あれば安全圏
→ 詳しくはAI金庫番（CFO）に相談

税理士からもらった試算表や決算書の数字を教えてもらえれば、
「うちはどうなの？」に3行で答えます。

売上・粗利・経費の合計、わかりますか？`
  }

  // 3年計画
  if (q.includes("3年") || q.includes("中期") || q.includes("長期") || q.includes("将来")) {
    return `3年計画を作りましょう。A4一枚で十分です。

まず「今の状態」を確認します。

教えてください：
1. 年間の販売台数はだいたい何台ですか？
2. 年間の売上はざっくりいくらですか？
3. スタッフは何名ですか？
4. 在庫は何台ですか？

次に「3年後にどうなっていたいか」を決めます。

例えば：
- 月販10台 → 15台にしたい
- スタッフ3名 → 5名に増やしたい
- 在庫30台 → 50台に拡大したい
- 2店舗目を出したい

目標が決まれば、逆算して：
- 1年目にやること（基盤固め）
- 2年目にやること（成長加速）
- 3年目にやること（目標達成）

を具体的に落とし込みます。

必要な投資があれば、補助金コンシェルジュAIで活用できる助成金を確認し、
採用が必要ならAI CHRO（人事参謀）で計画を立てます。

数字の裏付けは私が作り、AI副社長が最終判断を下す——この流れで進めましょう。

まず今の状態を教えてください。`
  }

  // 在庫分析
  if (q.includes("在庫") || q.includes("回転") || q.includes("滞留") || q.includes("売れ残")) {
    return `在庫の健康状態を分析しましょう。

在庫は「鮮度」で考えてください。中古車は生鮮食品と同じです。

在庫の4段階評価：
- 0〜30日：新鮮。通常販売でOK
- 31〜60日：注意。写真更新・値段見直しを検討
- 61〜90日：警告。値下げ or 広告強化が必要
- 91日以上：危険。損切り検討（AA出品・業販・大幅値下げ）

教えてください：
1. 今の在庫台数は何台ですか？
2. そのうち、仕入れから60日以上経っている車は何台ありますか？
3. 90日以上の車はありますか？

在庫に寝ているお金は「働いていないお金」です。
90日超えの車が在庫の20%を超えていたら、
値下げや業販での処分が最優先課題になります。

在庫を現金化して、新鮮な在庫に入れ替える方が
結果的に利益が増えるケースがほとんどです。

資金繰りへの影響はAI金庫番（CFO）で確認できます。`
  }

  // 広告費・CPA分析
  if (q.includes("広告") || q.includes("cpa") || q.includes("費用対効果")) {
    return `広告の費用対効果を見ましょう。

見るべき数字はシンプルです。

CPA（1台あたり広告費）＝ 月の広告費合計 ÷ 月の成約台数

判断基準：
- 1台の粗利の20%以内 → 効率的。今のまま継続
- 1台の粗利の20〜40% → 改善余地あり。媒体の見直しを検討
- 1台の粗利の40%超え → 費用対効果に問題。抜本的な見直しが必要

例えば1台の総合粗利が30万円なら：
- CPA 6万円以下 → 優秀
- CPA 6〜12万円 → 要改善
- CPA 12万円超え → 危険。広告のやり方を変えるべき

教えてください：
1. 毎月の広告費の合計はいくらですか？（ポータル掲載料等すべて含めて）
2. 月の成約台数は何台ですか？

CPAを計算した上で、どの媒体に問題があるかの切り分けは
AI集客参謀（CMO）と連携して進められます。`
  }

  // 人件費
  if (q.includes("人件費") || q.includes("給料") || q.includes("給与")) {
    return `人件費の適正水準を確認しましょう。

人件費率 ＝ 人件費合計 ÷ 粗利合計 × 100

中古車販売店の目安：
- 40%以下 → 健全。利益をしっかり残せている
- 40〜55% → 普通。ただし改善余地あり
- 55%超え → 要注意。売上が足りないか、人が余っている可能性

もう一つの指標：1人あたり粗利
＝ 年間粗利 ÷ スタッフ数（社長含む）

- 年間500万円以上 → 健全
- 年間300〜500万円 → 改善余地あり
- 年間300万円未満 → 生産性に問題

教えてください：
1. 毎月の人件費（社長の取り分含む）の合計はいくらですか？
2. 毎月の粗利合計はいくらですか？
3. スタッフは何名ですか？

人件費率が高い場合、原因は2つです：
A) 売上が足りない → AI集客参謀（CMO）で集客改善
B) 人が余っている → AI CHRO（人事参謀）で適正人員の検討

数字を見て、どちらが原因か切り分けます。`
  }

  // 初回ヒアリング（台数・粗利・固定費に反応）
  if (messageCount <= 3) {
    if (q.match(/\d+台/) || q.match(/\d+万/) || q.includes("台") || q.includes("万円")) {
      return `ありがとうございます。まず「トントンのライン」を出してみましょう。

教えていただいた数字から概算すると：

お店の状況を正確に把握するために、もう少し確認させてください。

1. 1台あたりの総合粗利はいくらですか？
  （車両本体の粗利だけでなく、諸費用・保険・ローン手数料も含めた合計）
  → わからなければ「仕入れ値と売値の差はだいたい○万円」でOKです

2. 毎月の固定費の内訳をざっくり教えてください：
  - 人件費（パート含む）：○万円
  - 家賃・地代：○万円
  - 広告費（カーセンサー等）：○万円
  - リース・借入返済：○万円
  - その他（光熱費・通信費等）：○万円

この2つがわかれば、
「月○台売れば赤字にならない」
「月○台売れば目標利益○万円を確保できる」
がはっきり出せます。`
    }
  }

  // デフォルト応答
  return `「${question}」について、数字で整理してお答えします。

的確な分析をするために、お店の基本数字を教えてください。

1. 月に何台くらい売れていますか？
2. 1台あたりの粗利はだいたいいくらですか？
3. 毎月の固定費（家賃・人件費・広告費等の合計）はいくらですか？

この3つがわかれば：
- 損益分岐点（トントンのライン）
- 今の利益水準
- 改善すべきポイント

を具体的な数字で示せます。

数字に基づく判断をすれば、「なんとなく不安」が「具体的な行動」に変わります。
ざっくりで構いません。教えてください。`
}

export function CpoChat() {
  return (
    <SharedChatLayout
      storageKey={STORAGE_KEY}
      initialMessage={INITIAL_MESSAGE}
      historyLabel="分析履歴"
      suggestedItems={suggestedTopics}
      suggestedLabel="数字で考えましょう"
      generateResponse={(question, messageCount) => generateCpoResponse(question, messageCount ?? 0)}
      theme="cpo"
      inputPlaceholder="数字や予算について相談してください..."
      typingDelay={1600}
    />
  )
}
