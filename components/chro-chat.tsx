"use client"

import { SharedChatLayout } from "@/components/shared-chat-layout"
import { Users, UserPlus, Heart, GraduationCap, Globe, AlertTriangle } from "lucide-react"

const suggestedTopics = [
  { icon: UserPlus, text: "求人を出しても応募が来ない" },
  { icon: Heart, text: "入って3ヶ月で辞められた" },
  { icon: GraduationCap, text: "社員の育て方がわからない" },
  { icon: Users, text: "社員のやる気が感じられない" },
  { icon: Globe, text: "外国人の整備士を入れたい" },
  { icon: AlertTriangle, text: "就業規則を作った方がいい？" },
]

const STORAGE_KEY = "symphony-chro-chat-history"

const INITIAL_MESSAGE = `こんにちは、「AI CHRO」——あなたのお店の人事参謀です。
中古車販売店・整備工場の「人の悩み」を一緒に考えます。

人が来ない、すぐ辞める、どう育てたらいい——
なんでも相談してください。今日できることから始めましょう。

まず、お店のことを少し教えてください。

1. スタッフは社長含めて何名ですか？
2. 今、一番困っている「人の問題」は何ですか？
3. 直近1年で辞めた人はいますか？`

const generateChroResponse = (question: string, messageCount: number): string => {
  const q = question.toLowerCase()

  // 初回ヒアリング（人事の健康診断）
  if (messageCount <= 3) {
    if (q.match(/\d+名/) || q.match(/\d+人/) || q.includes("スタッフ") || q.includes("社長")) {
      return `ありがとうございます。お店の人員構成が見えてきました。

規模に関わらず、人の問題は大きく3つに分かれます。
1. 人が来ない（採用の問題）
2. すぐ辞める（定着の問題）
3. 育て方がわからない（教育の問題）

今、一番困っているのはどれですか？
複数あっても大丈夫です。優先順位をつけて、1つずつ片付けましょう。

また、直近1年で辞めた方がいれば教えてください。
辞めた理由がわかると、対策が具体的になります。`
    }

    if (q.includes("来ない") || q.includes("応募") || q.includes("求人") || q.includes("採用")) {
      return `応募が来ない。これは業界全体の課題です。

正直に言います。中古車販売・整備業界の採用は非常に厳しい。
整備士の有効求人倍率は約5倍。求職者1人を5社で取り合っている状態です。

でも「打つ手がない」わけではありません。

まず確認させてください。
1. 今、どの方法で求人を出していますか？（ハローワーク、Indeed、紙媒体等）
2. 月にいくらくらい採用にお金をかけていますか？
3. どんな人が欲しいですか？（経験者？未経験OK？）

小規模店の採用は「お金をかける」ではなく「知恵を使う」が基本です。
状況を教えてください。具体的なアクションを出します。`
    }

    if (q.includes("辞め") || q.includes("離職") || q.includes("退職") || q.includes("やめ")) {
      return `人が辞める問題。これは採用の10倍難しい課題です。

結論を先に言います。
3ヶ月以内の離職は、ほぼ確実に「受け入れ体制」の問題です。
本人の問題にする前に、こちら側を見直しましょう。

確認させてください。
1. 辞めた人はどのくらいの期間で辞めましたか？
2. 辞める時に理由を聞きましたか？
3. 入社した時のオリエンテーションや研修はありましたか？
4. 「困ったらこの人に聞いてね」という担当者を決めていましたか？

離職理由のTOP3は：
- 給与の不満（「忙しさに見合わない」）
- 休日・労働時間の不満（「土日休めない」「残業が多い」）
- 人間関係（「教えてもらえない」「社長のワンマン」）

どれに近かったか、教えてください。対策を具体的に出します。`
    }

    if (q.includes("育て") || q.includes("教育") || q.includes("やる気") || q.includes("モチベーション")) {
      return `社員の育て方、悩みますよね。

結論から言います。
「やる気がない」ように見える時、多くの場合は「何をすれば評価されるかわからない」状態です。

社長がやるべきマネジメントは、実は3つだけでいいんです。

【1. 月1回の個別面談（1人10分）】
聞くことはこの3つだけ：
- 「先月で一番大変だったことは？」
- 「来月やってみたいことはある？」
- 「困っていることで、何かできることはある？」
社長が話すのは2割。聞くのが8割です。

【2. 「ありがとう」と「任せた」を意識して言う】
小さな権限移譲が人を育てます。

【3. 「うちの店は何のためにあるか」を折に触れて語る】
大企業のような理念は不要。「地元の人が安心して車に乗れる店」で十分です。

今、この3つのうち、どれが一番できていませんか？
そこから始めましょう。`
    }

    if (q.includes("外国人") || q.includes("特定技能") || q.includes("技能実習")) {
      return `外国人材の受け入れ、選択肢として有力です。

ただし、いくつか確認させてください。

1. 御社は認証工場または指定工場ですか？
   （特定技能「自動車整備」は認証工場以上が条件です）
2. 初年度に100〜200万円程度の費用をかけられますか？
   （登録支援機関への委託費、住居確保、渡航費等）
3. 住居（アパート等）を会社で用意できますか？
4. 社内の日本人社員への説明は済んでいますか？

すべてYesなら、まず登録支援機関に相談することをおすすめします。

なお、2027年4月から「育成就労制度」が始まります。
3年間の育成期間を経て特定技能1号に移行する新しい仕組みです。
今すぐ急がない場合は、この新制度の詳細が固まるのを待つのもひとつの手です。

★外国人材の受け入れは法律・制度が複雑です。
具体的な手続きは必ず行政書士・登録支援機関に相談してください。

上の1〜4について教えてください。判断を出します。`
    }
  }

  // 中盤以降の応答
  if (q.includes("indeed") || q.includes("インディード") || q.includes("求人サイト")) {
    return `Indeed、現時点で小規模店の採用チャネルとしては最有力です。

理由は3つ：
- 求職者の大多数が最初に見る求人検索エンジン
- 無料掲載が可能。有料でも1日500円〜から始められる
- 地域×職種の検索に強い

【今週やること】

1. Indeedに無料掲載する（まだやっていなければ）

2. 求人原稿を書き直す。以下の3点が最重要：
   - 職種名を具体的に（「スタッフ」はNG→「中古車の販売スタッフ」）
   - 給与を明確に（「応相談」はNG→「月給25万円〜35万円」）
   - 1日の流れがイメージできる仕事内容

3. お店の写真を最低3枚は載せる
   職場の雰囲気がわからない求人には応募が来ません。

【"不人気業界"のハンデを克服する書き方】
求職者は「休みが少なそう」「ノルマきつそう」「怖い人がいそう」と思っています。
求人原稿でこの不安を先回りして解消してください：
- 年間休日数を明記
- 月平均残業時間を正直に書く
- スタッフの雰囲気・年齢構成を記載

2週間様子を見て、応募が来なければ原稿を修正しましょう。
原稿が悪いまま広告費を増やしても無駄です。`
  }

  if (q.includes("紹介") || q.includes("リファラル")) {
    return `社員紹介（リファラル採用）は、小規模店に最も向いている採用方法です。

なぜか：
- ミスマッチが起きにくい（既存社員が「一緒に働きたい人」を連れてくる）
- 新人が孤立しにくい（紹介者がいる）＝定着率が高い
- コストはほぼゼロ

【今週やること】

1. 全スタッフに「良い人がいたら紹介してほしい」と声をかける
   これだけでも効果あり。言わなければ社員は「自分が紹介していい」と思いません。

2. 紹介お礼金を設定する
   相場：3〜10万円（入社後3ヶ月経過で支給が一般的）
   ★具体的な制度設計は社労士に確認してください

3. 「どんな人を探しているか」を具体的に伝える
   「誰でもいい」は逆効果。「車が好きで、朝起きられる人」くらいでOKです。

4. 紹介してくれたら結果に関わらず「ありがとう」を伝える
   不採用でも感謝しないと、二度と紹介してくれなくなります。

並行してIndeedにも掲載しておくと、チャネルが2つになります。
スタッフが2〜3名の場合は紹介の母数が限られるので、Indeed併用が前提です。`
  }

  if (q.includes("評価") || q.includes("昇給") || q.includes("給料") || q.includes("給与")) {
    return `「何をすれば給料が上がるか」を明確にする。これだけで社員の目の色が変わります。

小規模店で複雑な人事評価制度は不要です。
ただし「根拠がある昇給」は社員の納得感が全く違います。

【シンプル評価シート例（営業スタッフ）】
- 月間販売台数：目標に対する達成率
- お客様対応：クレームの有無・口コミ評価
- チームワーク：報告・連絡・相談ができているか
- 自己成長：新しいことに挑戦しているか

【シンプル評価シート例（整備士）】
- 技術力：対応できる作業の幅・精度
- 作業スピード：標準工数に対する実績
- 安全管理：ヒヤリハット報告
- 資格取得：上位資格への挑戦

これを半年に1回、面談のときに使う。
金額は小さくても「根拠がある昇給」にしてください。

まず、今の給与体系はどうなっていますか？
昇給のルールはありますか？ 状況を教えてください。`
  }

  if (q.includes("受け入れ") || q.includes("初日") || q.includes("研修") || q.includes("オリエン")) {
    return `新人の受け入れ体制。ここが3ヶ月離職を防ぐ最大のポイントです。

【入社初日 — 「歓迎されている」と感じさせる】
- 社長から全員に紹介する（「○○さんが今日から仲間です」）
- デスクかロッカーを用意しておく（「あなたの場所がある」）
- 初日のスケジュールを事前に伝えておく
- ランチを一緒に食べる（孤立させない）

【最初の1週間 — いきなり「やって覚えろ」は絶対NG】
最低限のマニュアルを用意する（A4数枚で十分）：
- 1日の流れ（開店準備→営業→閉店作業）
- 電話の取り方
- 報告・連絡・相談のルール
- 「わからないことは○○さんに聞いてね」と担当を決める

【最初の1ヶ月 — 週1回10分の声かけ】
「困っていることない？」と聞く。
「できたこと」をフィードバックする（ダメ出しの前に承認）。

【3ヶ月目 — 試用期間終了面談】
「あなたのここが良い」「ここを伸ばしてほしい」を具体的に。
「半年後には仕入れにも一緒に行こう」等の見通しを示す。

今の受け入れ体制はどうなっていますか？
足りないところから整えましょう。`
  }

  if (q.includes("就業規則") || q.includes("労務") || q.includes("契約") || q.includes("社保") || q.includes("36")) {
    return `労務の最低ラインを整えましょう。

★以下は法律の概要です。具体的な対応は必ず社労士に相談してください。★

【最低限やっておくべき6つ】

1. 雇用契約書を書面で交付する
   口約束は最大のトラブルの元。テンプレは厚労省サイトからダウンロード可能

2. 労働時間を記録する
   タイムカード、勤怠アプリ（無料のものもある）、最悪でもノートの手書き
   残業代未払いは最も多い労務トラブルです

3. 社会保険に加入する
   法人は従業員1人から加入義務あり

4. 就業規則を作る
   10人以上は法的義務。10人未満でも作るべき
   社労士に依頼すれば10〜30万円程度

5. ハラスメント対策
   相談窓口の設置が義務化。外部（社労士等）を案内する形でもOK

6. 36協定の届出（残業がある場合）
   届出なしの残業は違法

今、この6つのうちどれができていますか？
できていないものから優先的に整えましょう。

人材関連の助成金（キャリアアップ助成金等）が使える可能性もあります。
詳細は補助金コンシェルジュAI（補助金相談）で確認できます。`
  }

  if (q.includes("キャリア") || q.includes("将来") || q.includes("独立")) {
    return `「この会社にいても先がない」と思われたら辞めます。
小さなお店でも「成長の階段」を見せることはできます。

【営業スタッフのキャリアパス例】
1年目：先輩と同行。接客の基本を覚える
2年目：1人でお客様対応。月の販売目標を持つ
3年目：仕入れにも参加。利益管理を学ぶ
5年目：店長候補。新人の教育を担当
将来：店長 or 独立支援

【整備士のキャリアパス例】
入社時：3級整備士。基本的な点検・整備
2年目：2級整備士取得。車検整備を1人で
5年目：検査員取得。工場の管理を任せる
将来：工場長 or 独立支援

各段階に「月給○万円」を入れて、金額は各店舗の実情に合わせてください。
「階段がある」と見せるだけで、社員の目の色が変わります。

今、社員にキャリアパスを示していますか？
資格取得支援はやっていますか？ 状況を教えてください。`
  }

  if (q.includes("兆候") || q.includes("サイン") || q.includes("辞めそう")) {
    return `離職の兆候を見逃さないための「5つのサイン」をお伝えします。

以下が出たら、1週間以内に個別で話す機会を作ってください。

1. 遅刻・欠勤が増えた
2. 口数が急に減った（以前は明るかったのに）
3. 「別に」「大丈夫です」が増えた
4. 同僚との雑談に加わらなくなった
5. 身だしなみが急にきちんとした（面接に行っている可能性）

話す時のポイント：
- 「辞めたいの？」とは聞かない
- 「最近どう？何か気になることある？」とオープンに
- 不満が出たら、全部を解決しようとしない
  → 「全部は無理だけど、○○は改善できると思う」と正直に
- その場で結論を出さなくてよい。「聞いた」こと自体が大事

「辞めたい」と言われてからでは遅いんです。
兆候の段階で手を打てれば、離職は大幅に減ります。

今、気になるスタッフはいますか？`
  }

  // デフォルト応答
  return `「${question}」について、人事参謀としてお答えします。

まず確認させてください。

1. スタッフは社長含めて何名ですか？
2. その問題はいつ頃から感じていますか？

人の問題は正解がないからこそ、「こうしてみましょう」→「ダメなら次の手」の姿勢が大事です。

判断の優先順位は常にこうです：
- まず「辞めさせない」（今いる人を守る）
- 次に「採用する」（新しい人を探す）
- その上で「育てる」（戦力にする）

採用にお金をかける前に、今いる人が辞めない仕組みを先に作りましょう。
人が辞める穴が空いたバケツに水を入れても、溜まりません。

状況を教えてください。具体的なアクションを出します。`
}

export function ChroChat() {
  return (
    <SharedChatLayout
      storageKey={STORAGE_KEY}
      initialMessage={INITIAL_MESSAGE}
      historyLabel="相談履歴"
      suggestedItems={suggestedTopics}
      suggestedLabel="人の悩み、何でもご相談ください"
      generateResponse={(question, messageCount) => generateChroResponse(question, messageCount ?? 0)}
      theme="chro"
      inputPlaceholder="人の悩みを話してください..."
      typingDelay={1600}
    />
  )
}
